<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Information</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha1/0.6.0/sha1.min.js"></script>
    <style>
    /* CSS styles remain unchanged */
    body {
        background-color: #000;
        color: #fff;
        font-family: Arial, sans-serif;
        text-align: center;
    }
    h1 {
        text-align: center;
    }
    #xmlContainer {
        margin: 3px auto;
        width: 50%;
    }
	body::-webkit-scrollbar {
    width: 5px; /* Chrome, Safari, and Opera */
}

.body::-webkit-scrollbar-track {
    background: transparent;
}

.body::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 5px;
}
    .popup-button {
        background-color: #ffffff;
        color: #000;
        padding: 3px 6px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 15px;
		margin-top: 0px;
        font-size: 13px;
    }
    .popup-button:hover {
        opacity: 0.7;
    }
    .popup-button-clicked {
        background-color: #000000;
        font-size: 12px;
        color: #ffffff;
    }
    #xmlPopup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 85%;
        max-height: 80%;
        overflow: hidden;
        background-color: #1e1e1e;
        color: #ffffff;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ffffff;
        box-shadow: 0px 0px 15px 0px #ffffff;
        text-align: left;
        z-index: 1;
    }
    .xml-box {
        border: 1px solid #ffffff;
        padding: 10px;
        flex-grow: 1;
        overflow-y: auto;
        max-height: calc(25 * 1.2em);
    }
    .xml-content {
        white-space: pre-wrap;
        font-size: 15x;
    }
    .button-container {
        display: flex;
        justify-content: center;
        margin-top: 1px;
        padding: 8px;
        align-items: flex-end;
    }
    .button-containerpopup {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        justify-content: space-between;
    }
    .copy-button,
    .close-button {
        background-color: #ffffff;
        color: #000;
        padding: 3px 5px;
        border: none;
        margin-top: 10px;
        border-radius: 5px;
        cursor: pointer;
    }
    .close-button:hover {
        opacity: 0.7;
    }
    .copy-button2-container {
        align-items: center;
        justify-content: space-between;
    }
    .copy-button2 {
        background-color: #ffffff;
        color: #000000;
        padding: 2px 2px;
        margin-right: 12px;
        margin-left: 70px;
        border: none;
        border-radius: 2px;
        cursor: pointer;
        font-size: 12px;
    }
    .copy-button2:hover {
        opacity: 0.7;
    }
    .copy-button2-clicked {
        background-color: #000000;
        font-size: 8px;
        color: #ffffff;
    }
    .copy-button-success {
        background-color: #000000 !important;
        color: #ffffff;
    }
    #xmlDataDisplay {
        margin: 0px 200px;
        align-items: center;
    }
    .container {
        display: flex;
        flex-direction: row;
    }
    .item {
        background-color: #1e1e1e;
        color: #fff;
        border-radius: 5px;
        margin: 4px;
        text-align: left;
        border: 1px solid #ffffff;
        box-shadow: 0px 0px 15px 0px #ffffff;
        padding: 4px;
        top: 50%;
        left: 50%;
    }
    .item-details {
        padding: 2px;
    }
    h2 {
        font-size: 24px;
        margin-bottom: 20px;
    }
    h3 {
        font-size: 24px;
        margin: 3px;
        color: #ffffff;
    }
	
	h4 {
        font-size: 22px;
        margin: -3px;
		margin-top: -5px;

        color: #ffffff;
    }
	

    .thumbnail-container {
    position: relative;
    display: flex;
	margin-bottom: 20px;
	margin-top: 5px;
    justify-content: center;
    align-items: center;
}

.thumbnail {
    height: 320px;
    display: block;
    margin: 0 10px;
    border: 1px solid #ffffff;
    border-radius: 10px;
    box-shadow: 0px 0px 12px 0px #ffffff;
}

.nav-button1 {
    background: none;
            border: 2px solid #ffffff;
            color: inherit;
            font-size: 20px;
            cursor: pointer;
            padding: 30px 9px 30px 8px;
			margin: 20px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
        }
		
.nav-button2 {
    background: none;
            border: 2px solid #ffffff;
            color: inherit;
            font-size: 20px;
            cursor: pointer;
            padding: 30px 9px 30px 8px;
			margin: 20px;
            border-radius: 7px;
            display: inline-flex;
            align-items: center;
        }

.nav-button:hover {
    opacity: 0.7;
}

    .field-box {
        display: flex;
        flex-direction: row;
        font-size: 16px;
        margin: 9px;
        text-align: left;
    }
    .copy-button-container {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
    }
    .field-box span {
        color: #ffffff;
    }
    .popup-button.non-existing-file {
        background-color: red !important;
        cursor: not-allowed;
    }
    .tooltip {
        position: relative;
        display: inline-block;
    }
    .tooltip .tooltiptext {
        visibility: hidden;
        width: 120px;
        background-color: black;
        color: #fff;
        text-align: center;
    }
    .tooltip:hover .tooltiptext {
        visibility: visible;
    }
    a {
        text-decoration: none;
        color: inherit;
    }
	
	.back-button {
            background: none;
            border: 1px solid #ffffff;
            color: inherit;
            font-size: 22px;
            cursor: pointer;
            padding: 5px 12px;
			margin-bottom: 0px;
			margin-top: 5px;
            border-radius: 7px;
            display: inline-flex;
            align-items: center;
        }
		
	.header-back-button {
            background: none;
            border: 1px solid #000000;
            color: inherit;
            font: inherit;
            cursor: pointer;
            padding: 3px;
			margin-top: 0px;
			margin-bottom: 1px;
            border-radius: 5px;
            display: inline-flex;
            align-items: center;
        }
    </style>
</head>
<body>
<div id="xmlDataDisplay">
	 <button class="header-back-button" onclick="history.back()">
        <h4 title="Back to all Objects">Object Information</h4>
    </button>
<div class="thumbnail-container">
    <button class="nav-button1" id="prevButton" onclick="navigateImage(-1)">&#9664;</button>
    <img id="thumbnail" src="" alt="Thumbnail" class="thumbnail">
    <button class="nav-button2" id="nextButton" onclick="navigateImage(1)">&#9654;</button>
</div>
    <div class="item">
        <div class="item-details">
            <h2 class="field-box nameField-field">
                <span class="copy-button2"
                    onclick="copyTextToClipboard(document.getElementById('nameField').textContent, this)">ðŸ“„</span>
                <span>Name: <span id="nameField"></span></span>
            </h2>
            <h2 class="field-box desc-field">
                <span class="copy-button2"
                    onclick="copyTextToClipboard(document.getElementById('description').textContent, this)">ðŸ“„</span>
                <span>Description: <span id="description"></span></span>
            </h2>
            <h2 class="field-box maker-field">
                <span class="copy-button2"
                    onclick="copyTextToClipboard(document.getElementById('maker').textContent, this)">ðŸ“„</span>
                <span>Maker: <span id="maker"></span></span>
            </h2>
            <h2 class="field-box author-field">
                <span class="copy-button2"
                    onclick="copyTextToClipboard(document.getElementById('author').textContent, this)">ðŸ“„</span>
                <span>Author: <span id="author"></span></span>
            </h2>
            <h2 class="field-box uuid-field">
                <span class="copy-button2"
                    onclick="copyTextToClipboard(document.getElementById('uuid').textContent, this)">ðŸ“„</span>
                <span>UUID: <span id="uuid"></span></span>
            </h2>
            <h2 class="field-box hdk-version-field">
                <span class="copy-button2"
                    onclick="copyTextToClipboard(document.getElementById('hdkVersion').textContent, this)">ðŸ“„</span>
                <span>HDK Version: <span id="hdkVersion"></span></span>
            </h2>
            <h2 class="field-box category-field">
                <span class="copy-button2"
                    onclick="copyTextToClipboard(document.getElementById('categoryField').textContent, this)">ðŸ“„</span>
                <span>Category: <span id="categoryField"></span></span>
            </h2>
            <h2 class="field-box timestamp-field">
                <span class="copy-button2"
                    onclick="copyTextToClipboard(document.getElementById('timestamp').textContent, this)">ðŸ“„</span>
                <span>Timestamp: <span id="timestamp"></span></span>
            </h2>
            <h2 class="field-box odc-sha1-field">
                <span class="copy-button2"
                    onclick="copyTextToClipboard(document.getElementById('odcSha1').textContent, this)">ðŸ“„</span>
                <span>ODC SHA1: <span id="odcSha1"></span></span>
            </h2>
            <h2 class="field-box filecount-field">
                <span class="copy-button2"
                    onclick="copyTextToClipboard(document.getElementById('filecount').textContent, this)">ðŸ“„</span>
                <span>Resource Count: <span id="filecount"></span></span>
            </h2>
        </div>
    </div>
    <div id="xmlContainer">
        <div class="button-container">
            <button class="popup-button" data-xmlfile="OBJECT.ODC" onclick="openPopup('OBJECT.ODC')">OBJECT.ODC</button>
            <button class="popup-button" data-xmlfile="CATALOGUEENTRY.XML" onclick="openPopup('CATALOGUEENTRY.XML')">CATALOGUEENTRY.XML</button>
            <button class="popup-button" data-xmlfile="RESOURCES.XML" onclick="openPopup('RESOURCES.XML')">RESOURCES.XML</button>
            <button class="popup-button" data-xmlfile="LOCALISATION.XML" onclick="openPopup('LOCALISATION.XML')">LOCALISATION.XML</button>
            <button class="popup-button" data-xmlfile="OBJECT.XML" onclick="openPopup('OBJECT.XML')">OBJECT.XML</button>
        </div>
    </div>
	 <button class="back-button" onclick="history.back()">Back to Grid</button>

    <div id="xmlPopup">
        <div class="xml-content-container">
            <div class="xml-box">
                <pre id="xmlContent" class="xml-content"></pre>
            </div>
            <div class="button-containerpopup">
                <button class="copy-button" id="copyXmlButton" onclick="copyToClipboard()">Copy XML</button>
                <button class="copy-button" id="downloadXmlButton" onclick="downloadXmlFromPopup()">Download XML</button>
                <button class="close-button" onclick="closePopup()">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- JavaScript functions to retrieve and populate data -->
<script>


window.addEventListener("load", () => {
    populateUUID();
    checkAndFillTimestamp();
    checkAndFillAuthor();
    getLocalizedObjectNameDescriptionAndCategory();
    checkFileExistenceForButtons();
});

async function getLocalizedObjectNameDescriptionAndCategory() {
    const uuid = getUUIDFromURL();
    if (!uuid) {
        console.error("UUID not found in the URL.");
        return;
    }

    try {
        const data16Content = await loadLocalFile('categories/All_Items.xml');
        const database = data16Content
            .trim()
            .split('\n')
            .map(line => line.split('|'))
            .map(fields => ({
                uuid: fields[0],
                name: fields[3] || "Name Not Found",
                description: fields[4] || "Description Not Found",
                category: fields[5] || "Category Not Found",
                maker: fields[6] || "Maker Not Found", 
                hdkVersion: fields[7].substring(4) || "Unknown", // Remove the first 4 characters
                filecount: fields[9] || "Filecount Not Found" 
            }));

        console.log('Database content:', database);

        const object = database.find(entry => entry.uuid === uuid);

        if (object) {
            document.getElementById("nameField").textContent = object.name;
            document.getElementById("description").textContent = object.description;
            const categorySegments = object.category.split('/');
            const lastTwoSegments = categorySegments.slice(-2);
            const finalCategory = lastTwoSegments.join('/');
            document.getElementById("categoryField").textContent = finalCategory;
            document.getElementById("maker").textContent = object.maker;
            document.getElementById("hdkVersion").textContent = object.hdkVersion;
            document.getElementById("filecount").textContent = object.filecount;
        } else {
            console.error("UUID not found in the database.");
        }
    } catch (error) {
        console.error("Error fetching or parsing data from the database file:", error);
    }
}

function checkAndFillAuthor() {
    const uuid = getUUIDFromURL();
    if (uuid) {
        const xmlFilePath = `DATA/${uuid}/OBJECT.XML`;

        function checkFileAndFillAuthor(filePath, fieldName) {
            fetch(filePath)
                .then(response => response.text())
                .then(data => {
                    const authorMatch = data.match(/<author[^>]*?>([^<]+)<\/author>/);
                    if (authorMatch) {
                        const authorValue = authorMatch[1];
                        const authorField = document.getElementById(fieldName);
                        if (authorField) {
                            authorField.textContent = authorValue;
                        }
                    } else {
                        const authorField = document.getElementById(fieldName);
                        if (authorField) {
                            authorField.textContent = "not found";
                        }
                    }
                })
                .catch(error => console.error(`Error checking ${fieldName}:`, error));
        }

        checkFileAndFillAuthor(xmlFilePath, 'author');
    } else {
        console.error("UUID not found in the URL.");
    }
}

async function checkAndFillTimestamp() {
    const uuid = getUUIDFromURL();
    if (!uuid) {
        console.error("UUID not found in the URL.");
        return;
    }

    const odcFilePath = `DATA/${uuid}/OBJECT.ODC`;

    try {
        const odcResponse = await fetch(odcFilePath);
        if (!odcResponse.ok) {
            throw new Error("ODC file not found");
        }

        const odcData = await odcResponse.text();

        const timestampMatch = odcData.match(/<timestamp>([^<]+)<\/timestamp>/);
        if (timestampMatch) {
            const timestampValue = timestampMatch[1];
            const timestampField = document.getElementById('timestamp');
            if (timestampField) {
                timestampField.textContent = timestampValue;
            } else {
                console.log("Timestamp field element not found.");
            }
        } else {
            console.log("Timestamp not found in OBJECT.ODC.");
        }
    } catch (error) {
        console.error("Error checking timestamp:", error);

        if (error.message === "ODC file not found") {
            const timestampField = document.getElementById('timestamp');
            if (timestampField) {
                timestampField.textContent = "ODC file not found";
            }
        } else {
            const timestampField = document.getElementById('timestamp');
            if (timestampField) {
                timestampField.textContent = "not found";
            }
        }
    }
}

function getUUIDFromURL() {
    const url = window.location.href;
    const uuidMatch = url.match(/[0-9a-fA-F-]+$/);

    if (uuidMatch && uuidMatch.length > 0) {
        return uuidMatch[0];
    } else {
        return null;
    }
}

function copyTextToClipboard(text, buttonElement) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);

    buttonElement.classList.add("copy-button2-clicked");

    setTimeout(() => {
        buttonElement.classList.remove("copy-button2-clicked");
    }, 500);
}

async function navigateImage(direction) {
    const uuid = getUUIDFromURL();
    if (!uuid) {
        console.error("UUID not found in the URL.");
        return;
    }

    try {
        const data16Content = await loadLocalFile('categories/All_Items.xml');
        const database = data16Content
            .trim()
            .split('\n')
            .map(line => {
                const fields = line.split('|');
                return {
                    uuid: fields[0],
                    category: fields[5]
                };
            });

        const currentItem = database.find(item => item.uuid === uuid);
        if (!currentItem) {
            console.error("UUID not found in the database.");
            return;
        }

        const sameCategoryItems = database.filter(item => item.category === currentItem.category);
        const currentIndex = sameCategoryItems.findIndex(item => item.uuid === uuid);
        if (currentIndex === -1) {
            console.error("UUID not found in the same category items.");
            return;
        }

        let newIndex = currentIndex + direction;
        if (newIndex < 0) {
            newIndex = sameCategoryItems.length - 1; // Loop to the last item
        } else if (newIndex >= sameCategoryItems.length) {
            newIndex = 0; // Loop to the first item
        }

        const newUUID = sameCategoryItems[newIndex].uuid;
        window.location.replace(`pshome_uuid.html?${newUUID}`); // Use replace instead of href
    } catch (error) {
        console.error("Error navigating images:", error);
    }
}


// Reuse the existing function to load local files
async function loadLocalFile(filePath) {
    return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", filePath, true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    resolve(xhr.responseText);
                } else {
                    reject(new Error(`Failed to load file: ${filePath}`));
                }
            }
        };
        xhr.send();
    });
}


function populateUUID() {
    const uuid = getUUIDFromURL();
    if (uuid) {
        const uuidElements = document.getElementsByClassName("uuid-field");
        for (const element of uuidElements) {
            const uuidSpan = element.querySelector("span[id='uuid']");
            if (uuidSpan) {
                uuidSpan.textContent = uuid;
            }
        }

        const thumbnailImg = document.getElementById("thumbnail");
        const thumbnailUrl = `http://psho.me/DATA/${uuid}/LARGE.PNG`;
        const thumbnailUrlFallback1 = `http://psho.me/DATA/${uuid}/SMALL.PNG`;
        const thumbnailUrlFallback2 = `http://psho.me/DATA/${uuid}/${uuid}.WEBP`;

        thumbnailImg.src = thumbnailUrl;

        let fallbackAttempts = 0;

        thumbnailImg.addEventListener("error", function handleImageError() {
            fallbackAttempts++;

            if (fallbackAttempts === 1) {
                thumbnailImg.src = thumbnailUrlFallback1;
            } else if (fallbackAttempts === 2) {
                thumbnailImg.src = thumbnailUrlFallback2;
            } else {
                console.error("All image fallbacks failed.");
            }
        });

        setTimeout(() => {
            const odcFilePath = `DATA/${uuid}/OBJECT.ODC`;
            fetch(odcFilePath)
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    } else {
                        return null;
                    }
                })
                .then(data => {
                    if (data) {
                        generateAndDisplaySHA1(data);
                    } else {
                        document.getElementById("odcSha1").textContent = "ODC file not found";
                    }
                })
                .catch(error => {
                    console.error("Error fetching OBJECT.ODC:", error);
                    document.getElementById("odcSha1").textContent = "ODC file not found";
                });
        }, 500);
    } else {
        console.error("UUID not found in the URL.");
    }
}

function generateAndDisplaySHA1(data) {
    try {
        const sha1Hash = sha1(data);
        document.getElementById("odcSha1").textContent = sha1Hash;
    } catch (error) {
        console.error("Error generating SHA1 hash:", error);
        document.getElementById("odcSha1").textContent = "N/A";
    }
}

async function loadLocalFile(filePath) {
    return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", filePath, true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    resolve(xhr.responseText);
                } else {
                    reject(new Error(`Failed to load file: ${filePath}`));
                }
            }
        };
        xhr.send();
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Existing code to execute when the DOM is fully loaded...

    // Disable default browser context menu
    document.addEventListener('contextmenu', function(event) {
        event.preventDefault();
    });
});


async function openPopup(xmlFile) {
    const uuid = getUUIDFromURL();
    if (uuid) {
        const filePath = `http://psho.me/DATA/${uuid}/${xmlFile}`;
        try {
            const data = await loadLocalFile(filePath);
            const xmlContent = document.getElementById("xmlContent");
            xmlContent.textContent = data;
            const xmlPopup = document.getElementById("xmlPopup");
            xmlPopup.style.display = "block";
            const downloadXmlButton = document.getElementById("downloadXmlButton");
            downloadXmlButton.dataset.filename = xmlFile;
        } catch (error) {
            console.error(`Error fetching ${xmlFile}:`, error);
            const button = document.querySelector(`button[data-xmlfile="${xmlFile}"]`);
            button.style.backgroundColor = "red";
            button.style.cursor = "not-allowed";
            button.disabled = true;
        }
    } else {
        console.error("UUID not found in the URL.");
    }
}

function copyToClipboard() {
    const xmlContent = document.getElementById("xmlContent");
    const textArea = document.createElement("textarea");
    textArea.value = xmlContent.textContent;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    const copyXmlButton = document.getElementById("copyXmlButton");
    copyXmlButton.classList.add("copy-button-success");
    setTimeout(() => {
        copyXmlButton.classList.remove("copy-button-success");
    }, 500);
}

function closePopup() {
    const xmlPopup = document.getElementById("xmlPopup");
    xmlPopup.style.display = "none";
    const copyXmlButton = document.getElementById("copyXmlButton");
    copyXmlButton.classList.remove("copy-button-success");
}

const xmlPopup = document.getElementById("xmlPopup");

document.addEventListener("click", function (event) {
    if (!xmlPopup.contains(event.target)) {
        closePopup();
    }
});

function downloadXmlFromPopup() {
    const xmlContent = document.getElementById("xmlContent");
    const data = xmlContent.textContent;
    const filename = document.getElementById("downloadXmlButton").dataset.filename;
    const blob = new Blob([data], { type: 'application/xml' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
}

async function fileExists(filePath) {
    try {
        const response = await fetch(filePath);
        return response.status === 200;
    } catch (error) {
        return false;
    }
}

async function checkFileExistenceForButtons() {
    const xmlFiles = [
        'OBJECT.ODC',
        'CATALOGUEENTRY.XML',
        'RESOURCES.XML',
        'LOCALISATION.XML',
        'OBJECT.XML'
    ];

    for (const xmlFile of xmlFiles) {
        const uuid = getUUIDFromURL();
        if (uuid) {
            const filePath = `http://psho.me/DATA/${uuid}/${xmlFile}`;
            const fileExistsResult = await fileExists(filePath);
            if (!fileExistsResult) {
                const button = document.querySelector(`button[data-xmlfile="${xmlFile}"]`);
                button.classList.add("non-existing-file");
                button.disabled = true;
            }
        } else {
            console.error("UUID not found in the URL.");
        }
    }
}

async function fileExists(filePath) {
    try {
        const response = await fetch(filePath);
        return response.status === 200;
    } catch (error) {
        return false;
    }
}


</script>
</body>
</html>
